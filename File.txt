import google.generativeai as genai
import telebot
from telebot import types
from config import TELEGRAM_BOT_TOKEN, GEMINI_API_KEY, GEMINI_MODEL, MAX_MEMORY, VED_SYSTEM_PROMPT
import logging
from typing import Dict, List
from datetime import datetime

logging.basicConfig(format='%(asctime)s - %(name)s - %(levelname)s - %(message)s', level=logging.INFO)
logger = logging.getLogger(__name__)

genai.configure(api_key=GEMINI_API_KEY)
bot = telebot.TeleBot(TELEGRAM_BOT_TOKEN)
chat_memory: Dict[int, List[Dict]] = {}
states = {}
STAVKI_FILE = 'stavki-china.txt'

def count_tokens(messages: List[Dict]) -> int:
    total = 0
    for msg in messages:
        total += len(msg["content"]) // 4 + 2
    return total

def get_gemini_response(chat_id: int, user_input: str) -> str:
    # âœ… ĞĞĞ’ĞĞ•: ĞĞ¢Ğ’Ğ•Ğ§ĞĞ•Ğœ ĞĞ ĞšĞĞ–Ğ”Ğ«Ğ™ Ğ’ĞĞŸĞ ĞĞ¡ ĞŸĞĞ›ĞĞĞ¡Ğ¢Ğ¬Ğ®!
    model = genai.GenerativeModel(GEMINI_MODEL)
    chat = model.start_chat(history=[{"role": "model", "parts": [{"text": VED_SYSTEM_PROMPT}]}])
    chat.send_message(user_input)
    
    try:
        response = chat.send_message(user_input)
        answer = response.text
        logger.info(f"âœ… ĞŸĞ¾Ğ»Ğ½Ñ‹Ğ¹ Ğ¾Ñ‚Ğ²ĞµÑ‚ Ğ½Ğ°: {user_input[:50]}")
        return answer
    except Exception as e:
        return f"âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Gemini: {str(e)[:100]}"

def parse_number(text):
    return float(text.replace(',', '.'))

def load_stavki():
    with open(STAVKI_FILE, 'r', encoding='utf-8') as f:
        lines = f.readlines()
    return float(lines[0].strip()), float(lines[1].strip()), float(lines[2].strip())

@bot.message_handler(commands=['start'])
def start(message):
    markup = types.ReplyKeyboardMarkup(resize_keyboard=True, row_width=2)
    btn1 = types.KeyboardButton("ğŸšš Ğ Ğ°ÑÑ‡ĞµÑ‚ Ğ³Ñ€ÑƒĞ·Ğ¾Ğ²")
    btn2 = types.KeyboardButton("ğŸ¤– Ğ¡Ğ¿Ñ€Ğ¾ÑĞ¸Ñ‚ÑŒ Ğ’Ğ­Ğ”")
    markup.add(btn1, btn2)
    bot.send_message(message.chat.id, 
        "ğŸšš **Ğ¡Ğ£ĞŸĞ•Ğ -Ğ‘ĞĞ¢ Ğ›Ğ¾Ğ³Ğ¸ÑÑ‚Ğ¸ĞºĞ° + Ğ’Ğ­Ğ”**\n\n"
        "â€¢ *ğŸšš Ğ Ğ°ÑÑ‡ĞµÑ‚ Ğ³Ñ€ÑƒĞ·Ğ¾Ğ²* â€” ĞšĞ¸Ñ‚Ğ°Ğ¹-Ğ Ğ¾ÑÑĞ¸Ñ\n"
        "â€¢ *ğŸ¤– Ğ¡Ğ¿Ñ€Ğ¾ÑĞ¸Ñ‚ÑŒ Ğ’Ğ­Ğ”* â€” Ñ‚Ğ°Ğ¼Ğ¾Ğ¶Ğ½Ñ, Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ñ‹\n\n"
        f"**ĞœĞ¾Ğ´ĞµĞ»ÑŒ Ğ˜Ğ˜:** `{GEMINI_MODEL}`\n"
        "**âœ… ĞÑ‚Ğ²ĞµÑ‡Ğ°ĞµÑ‚ Ğ½Ğ° ĞºĞ°Ğ¶Ğ´Ñ‹Ğ¹ Ğ²Ğ¾Ğ¿Ñ€Ğ¾Ñ ĞŸĞĞ›ĞĞĞ¡Ğ¢Ğ¬Ğ®!**", 
        parse_mode='Markdown', reply_markup=markup)

@bot.message_handler(func=lambda m: m.text == "ğŸšš Ğ Ğ°ÑÑ‡ĞµÑ‚ Ğ³Ñ€ÑƒĞ·Ğ¾Ğ²")
def start_calc(message):
    states[message.chat.id] = {'step': 0}
    bot.send_message(message.chat.id, "ğŸ“ *ĞÑ‚ĞºÑƒĞ´Ğ° Ğ·Ğ°Ğ±Ğ¸Ñ€Ğ°Ñ‚ÑŒ Ğ³Ñ€ÑƒĞ·?*")

@bot.message_handler(func=lambda m: m.text == "ğŸ¤– Ğ¡Ğ¿Ñ€Ğ¾ÑĞ¸Ñ‚ÑŒ Ğ’Ğ­Ğ”")
def start_ai(message):
    bot.send_message(message.chat.id, 
        "ğŸ¤– **Ğ’Ğ­Ğ”-Ğ­ĞºÑĞ¿ĞµÑ€Ñ‚ Ğ³Ğ¾Ñ‚Ğ¾Ğ²!**\n"
        "âœ… *ĞÑ‚Ğ²ĞµÑ‡Ğ°Ñ ĞŸĞĞ›ĞĞĞ¡Ğ¢Ğ¬Ğ® Ğ½Ğ° ĞºĞ°Ğ¶Ğ´Ñ‹Ğ¹ Ğ²Ğ¾Ğ¿Ñ€Ğ¾Ñ!*\n\n"
        "Ğ—Ğ°Ğ´Ğ°Ğ¹Ñ‚Ğµ Ğ²Ğ¾Ğ¿Ñ€Ğ¾Ñ Ğ¿Ğ¾:\n"
        "â€¢ Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚/ÑĞºÑĞ¿Ğ¾Ñ€Ñ‚\n"
        "â€¢ Ğ¢Ğ°Ğ¼Ğ¾Ğ¶Ğ½Ñ, HS-ĞºĞ¾Ğ´Ñ‹\n"
        "â€¢ Ğ”Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ñ‹, INCOTERMS\n\n"
        "*ĞŸÑ€Ğ¸Ğ¼ĞµÑ€:* 'ĞÑƒĞ¶ĞµĞ½ Ğ»Ğ¸ ÑĞµÑ€Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ‚ Ğ´Ğ»Ñ Ñ‚ĞµĞºÑÑ‚Ğ¸Ğ»Ñ Ğ¸Ğ· ĞšĞ¸Ñ‚Ğ°Ñ?'")

@bot.message_handler(func=lambda message: message.chat.id in states)
def handle_calc(message):
    chat_id = message.chat.id
    if chat_id not in states:
        return
    state = states[chat_id]
    step = state['step']
    
    if step == 0:
        state['from_location'] = message.text
        bot.send_message(chat_id, "ğŸ“ *ĞšÑƒĞ´Ğ° Ğ²ĞµĞ·Ñ‚Ğ¸?*")
        state['step'] = 1
    elif step == 1:
        state['to_location'] = message.text
        bot.send_message(chat_id, "âš–ï¸ *Ğ’ĞµÑ (ĞºĞ³)?* ĞŸÑ€Ğ¸Ğ¼ĞµÑ€Ñ‹: 150, 150,5")
        state['step'] = 2
    elif step == 2:
        try:
            state['weight'] = parse_number(message.text)
            bot.send_message(chat_id, "ğŸ“¦ *ĞĞ±ÑŠĞµĞ¼ (Ğ¼Â³)?* ĞŸÑ€Ğ¸Ğ¼ĞµÑ€Ñ‹: 0,5")
            state['step'] = 3
        except:
            bot.send_message(chat_id, "âŒ Ğ§Ğ¸ÑĞ»Ğ¾! ĞŸÑ€Ğ¸Ğ¼ĞµÑ€: 150,5")
    elif step == 3:
        try:
            state['volume'] = parse_number(message.text)
            bot.send_message(chat_id, "ğŸ”¢ *ĞšĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ¼ĞµÑÑ‚?*")
            state['step'] = 4
        except:
            bot.send_message(chat_id, "âŒ Ğ§Ğ¸ÑĞ»Ğ¾! ĞŸÑ€Ğ¸Ğ¼ĞµÑ€: 0,5")
    elif step == 4:
        try:
            state['places'] = int(parse_number(message.text))
            
            rate_to, rate_from, kg_per_cub = load_stavki()
            effective_vol = max(state['volume'], state['weight'] / kg_per_cub)
            effective_vol = max(effective_vol, 1.0)
            cost_to = effective_vol * rate_to
            cost_from = effective_vol * rate_from
            total_cost = cost_to + cost_from
            
            response = (
                f"ğŸšš **Ğ ĞĞ¡Ğ§Ğ•Ğ¢ Ğ›ĞĞ“Ğ˜Ğ¡Ğ¢Ğ˜ĞšĞ˜**\n\n"
                f"ğŸ“ {state['from_location']} â†’ {state['to_location']}\n\n"
                f"âš–ï¸ {state['weight']:.1f} ĞºĞ³ | ğŸ“¦ {state['volume']:.2f} Ğ¼Â³ | ğŸ”¢ {state['places']} Ğ¼ĞµÑÑ‚\n\n"
                f"ğŸ›• *Ğ”Ğ ĞœĞĞĞ§Ğ–Ğ£Ğ Ğ˜Ğ˜:* {cost_to:.0f} USD\n"
                f"ğŸ‡¨ğŸ‡³ *Ğ˜Ğ— ĞœĞĞĞ§Ğ–Ğ£Ğ Ğ˜Ğ˜:* {cost_from:.0f} USD\n\n"
                f"ğŸ’ **Ğ˜Ğ¢ĞĞ“Ğ: {total_cost:.0f} USD**"
            )
            
            bot.send_message(chat_id, response, parse_mode='Markdown')
            del states[chat_id]
            
            markup = types.ReplyKeyboardMarkup(resize_keyboard=True, row_width=2)
            markup.add(types.KeyboardButton("ğŸšš Ğ•Ñ‰Ğµ Ñ€Ğ°ÑÑ‡ĞµÑ‚"), types.KeyboardButton("ğŸ¤– Ğ’Ğ­Ğ”"))
            bot.send_message(chat_id, "Ğ§Ñ‚Ğ¾ Ğ´Ğ°Ğ»ÑŒÑˆĞµ?", reply_markup=markup)
            
        except:
            bot.send_message(chat_id, "âŒ Ğ¦ĞµĞ»Ğ¾Ğµ Ñ‡Ğ¸ÑĞ»Ğ¾ Ğ´Ğ»Ñ Ğ¼ĞµÑÑ‚!")

@bot.message_handler(func=lambda m: m.chat.id not in states)
def handle_ai(message):
    chat_id = message.chat.id
    user_text = message.text.strip()
    
    markup = types.ReplyKeyboardMarkup(resize_keyboard=True, row_width=2)
    markup.add(types.KeyboardButton("ğŸšš Ğ Ğ°ÑÑ‡ĞµÑ‚ Ğ³Ñ€ÑƒĞ·Ğ¾Ğ²"), types.KeyboardButton("ğŸ¤– Ğ¡Ğ¿Ñ€Ğ¾ÑĞ¸Ñ‚ÑŒ Ğ’Ğ­Ğ”"))
    
    bot.send_message(chat_id, "ğŸ¤– *ĞÑ‚Ğ²ĞµÑ‡Ğ°Ñ ĞŸĞĞ›ĞĞĞ¡Ğ¢Ğ¬Ğ®...*", parse_mode='Markdown')
    answer = get_gemini_response(chat_id, user_text)
    bot.send_message(chat_id, answer, parse_mode='Markdown', reply_markup=markup)

@bot.message_handler(commands=['test'])
def test_api(message):
    bot.send_message(message.chat.id, "ğŸ§ª Ğ¢ĞµÑÑ‚Ğ¸Ñ€ÑƒÑ...")
    try:
        model = genai.GenerativeModel(GEMINI_MODEL)
        response = model.generate_content("ĞŸÑ€Ğ¸Ğ²ĞµÑ‚!")
        bot.send_message(message.chat.id, f"âœ… **Ğ˜Ğ˜ Ğ ĞĞ‘ĞĞ¢ĞĞ•Ğ¢!**\n{response.text}")
    except Exception as e:
        bot.send_message(message.chat.id, f"âŒ {str(e)}")

@bot.message_handler(commands=['clear'])
def clear(message):
    chat_id = message.chat.id
    bot.send_message(chat_id, "ğŸ§¹ **Ğ§Ğ°Ñ‚ Ğ¾Ñ‡Ğ¸Ñ‰ĞµĞ½!**")

@bot.message_handler(commands=['status'])
def status(message):
    bot.send_message(message.chat.id, "ğŸ“Š **âœ… ĞŸĞ¾Ğ»Ğ½Ñ‹Ğµ Ğ¾Ñ‚Ğ²ĞµÑ‚Ñ‹ Ğ½Ğ° ĞºĞ°Ğ¶Ğ´Ñ‹Ğ¹ Ğ²Ğ¾Ğ¿Ñ€Ğ¾Ñ!**")

if __name__ == "__main__":
    with open(STAVKI_FILE, 'w') as f:
        f.write("50\n110\n300")
    
    print("ğŸššğŸ¤– Ğ¡Ğ£ĞŸĞ•Ğ -BOT Ğ—ĞĞŸĞ£Ğ©Ğ•Ğ! âœ… ĞŸĞĞ›ĞĞ«Ğ• ĞĞ¢Ğ’Ğ•Ğ¢Ğ«!")
    print("â€¢ /start â€” Ğ¼ĞµĞ½Ñ")
    print("â€¢ ğŸšš Ğ Ğ°ÑÑ‡ĞµÑ‚ Ğ³Ñ€ÑƒĞ·Ğ¾Ğ²")
    print("â€¢ ğŸ¤– Ğ’Ğ­Ğ” Ğ²Ğ¾Ğ¿Ñ€Ğ¾ÑÑ‹ (100 Ñ€Ğ°Ğ·!)")
    print("â€¢ /test â€” Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ Ğ˜Ğ˜")
    
    bot.polling(none_stop=True)
